---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import BlogCard from '../../components/BlogCard.astro';
import TagFilter from '../../components/TagFilter.astro';
import CategoryFilter from '../../components/CategoryFilter.astro';
import { getBlogPosts, getAllTags, getAllCategories, filterPostsByTag, filterPostsByCategory } from '../../utils/blog';

const allPosts = await getBlogPosts();
const allTags = getAllTags(allPosts);
const allCategories = getAllCategories(allPosts);

const url = Astro.url;
const tagParam = url.searchParams.get('tag');
const categoryParam = url.searchParams.get('category');

let filteredPosts = allPosts;
if (tagParam) {
  filteredPosts = filterPostsByTag(allPosts, tagParam);
} else if (categoryParam) {
  filteredPosts = filterPostsByCategory(allPosts, categoryParam);
}

const baseUrl = import.meta.env.BASE_URL;
---

<BaseLayout title="Blog - My Blog" description="블로그 포스트 목록">
  <Header />
  <main class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8">Blog</h1>
    
    <CategoryFilter categories={allCategories} currentCategory={categoryParam || undefined} />
    <TagFilter tags={allTags} currentTag={tagParam || undefined} />

    {filteredPosts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredPosts.map((post) => (
          <BlogCard
            title={post.title}
            description={post.description}
            pubDate={post.pubDate}
            tags={post.tags}
            category={post.category}
            url={`${baseUrl}blog/${post.slug}`}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400 text-lg">포스트를 찾을 수 없습니다.</p>
        <a href={`${baseUrl}blog`} class="text-primary-600 dark:text-primary-400 hover:underline mt-4 inline-block">
          전체 포스트 보기
        </a>
      </div>
    )}
  </main>
</BaseLayout>

